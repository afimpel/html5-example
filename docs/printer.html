<!DOCTYPE html>
<html>
  <head>
    <title>JavaScript PRINTER API</title>
  </head>

  <body style="font-size: 24px; padding: 1rem">
    <h1 style="text-align: center; border: 1px solid green; padding: 1rem">
      JavaScript PRINTER API
    </h1>
    <pre
      style="border: 1px solid green; padding: 1rem; white-space: pre-wrap"
      id="alerts"
    ></pre>
    <textarea id="printContent"></textarea>
    <input type="submit" onclick="connectAndPrint()" value="Print" />

    <p>Type text into box and click on submit button.</p>
    <script>
      const alerts = document.getElementById("alerts");
      var device;

      function setup(device) {
        alerts.innerHTML = newDevice(device); // "Arduino LLC"
        return device
          .open()
          .then(() => device.selectConfiguration(1))
          .then(() => device.claimInterface(0));
      }

      function print() {
        var string = document.getElementById("printContent").value + "\n";
        var encoder = new TextEncoder();
        var data = encoder.encode(string);
        alerts.innerHTML = newDevice(device); // "Arduino LLC"
        device.transferOut(1, data).catch((error) => {
          console.error(error);
        });
      }

      function connectAndPrint() {
        alerts.innerHTML = "";
        if (device == null) {
          navigator.usb
            .requestDevice({ filters: [{ vendorId: 1008 }] })
            .then((selectedDevice) => {
              device = selectedDevice;
              alerts.innerHTML = newDevice(device); // "Arduino LLC"
              console.log(device);
              return setup(device);
            })
            .then(() => print())
            .catch((error) => {
              console.error(error);
            });
        } else print();
      }

      navigator.usb
        .getDevices()
        .then((devices) => {
          if (devices.length > 0) {
            device = devices[0];
            alerts.innerHTML = newDevice(device); // "Arduino LLC"
            return setup(device);
          }
        })
        .catch((error) => {
          console.error(error);
        });

      function newDevice(deviceOBJ) {
        console.log(`deviceOBJ: ${deviceOBJ.productName} >> `, deviceOBJ);
        console.table(deviceOBJ);
        let output = "";
        output += `manufacturerName: <b>${deviceOBJ.manufacturerName}</b>, `;
        output += `productName: <b>${deviceOBJ.productName}</b>, `;
        output += `serialNumber: <b>${deviceOBJ.serialNumber}</b>, `;
        output += `vendorId: <b>${deviceOBJ.vendorId}</b>, `;
        output += `productId: <b>${deviceOBJ.productId}</b>.`;
        return output;
      }
    </script>
  </body>
</html>
